<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>C's Family NFT Mint</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Link external CSS -->
  <link rel="stylesheet" href="styles.css" />
  <!-- Ethers.js CDN (for simplicity) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
</head>
<body>
  <header>
    <h1>C's Family NFT Mint</h1>
    <div class="wallet-status" id="walletStatus">
      Wallet not connected
    </div>
    <button class="connect-button" id="connectWalletBtn">Connect Wallet</button>
  </header>

  <main>
    <section class="mint-container">
      <h2>Mint Your C's Family NFT</h2>
      <p>
        Supply Remaining: <span id="supplyRemaining">--</span> / 50
      </p>
      <button class="mint-button" id="mintBtn">Mint Now</button>
    </section>
  </main>

  <footer>
    <p>Â© 2025 C's Family Project</p>
  </footer>

  <!-- JavaScript -->
  <script>
    // Replace with your actual contract address after deployment
    const CONTRACT_ADDRESS = "YOUR_CONTRACT_ADDRESS_HERE";

    // ABI for CsFamilyNFT (only the parts we need: mintedSoFar, leftToMint, mint)
    const CONTRACT_ABI = [
      "function mintedSoFar() external view returns (uint256)",
      "function leftToMint() external view returns (uint256)",
      "function mint() external",
    ];

    // Network parameters for Monad Devnet
    const MONAD_NETWORK = {
      chainId: "0x4EB7", // 20143 in decimal, hex is 0x4EB7
      chainName: "Monad Devnet",
      nativeCurrency: {
        name: "Monad Devnet",
        symbol: "DMON",
        decimals: 18,
      },
      rpcUrls: ["https://rpc-devnet.monadinfra.com/rpc/3fe540e310bbb6ef0b9f16cd23073b0a"],
      blockExplorerUrls: ["https://explorer.monad-devnet.devnet101.com/"],
    };

    // DOM elements
    const connectWalletBtn = document.getElementById("connectWalletBtn");
    const walletStatus = document.getElementById("walletStatus");
    const mintBtn = document.getElementById("mintBtn");
    const supplyRemaining = document.getElementById("supplyRemaining");

    // Global provider and signer
    let provider;
    let signer;
    let contract;

    // On page load, check if MetaMask is installed
    window.addEventListener("load", async () => {
      if (typeof window.ethereum === "undefined") {
        alert("MetaMask (or another wallet) is not installed.");
        return;
      }
      // Attempt to fetch supply right away (will fail if not connected)
      // So we do that after wallet connection to avoid confusion.
    });

    // Connect wallet button
    connectWalletBtn.addEventListener("click", async () => {
      if (!window.ethereum) {
        alert("No wallet found. Please install MetaMask.");
        return;
      }

      try {
        // Request to add or switch to Monad Devnet
        await setupMonadNetwork();

        // Request account access
        const accounts = await window.ethereum.request({
          method: "eth_requestAccounts",
        });

        if (accounts.length > 0) {
          walletStatus.textContent = `Connected: ${accounts[0]}`;
          // Setup provider, signer, contract
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

          // Update supply info
          await updateSupplyInfo();
        }
      } catch (error) {
        console.error(error);
        walletStatus.textContent = "Connection error";
      }
    });

    // Mint button
    mintBtn.addEventListener("click", async () => {
      if (!contract) {
        alert("Please connect your wallet first.");
        return;
      }

      try {
        // Call mint()
        const tx = await contract.mint();
        await tx.wait(); // Wait for transaction to be mined

        alert("NFT minted successfully!");
        // Update supply info after mint
        await updateSupplyInfo();
      } catch (error) {
        console.error(error);
        alert(error.message || "Mint failed.");
      }
    });

    // Function to update the "Supply Remaining" text
    async function updateSupplyInfo() {
      if (!contract) return;
      try {
        const left = await contract.leftToMint();
        supplyRemaining.textContent = left.toString();
      } catch (error) {
        console.error("Error fetching supply info:", error);
      }
    }

    /**
     * Helper function to request adding or switching to the Monad Devnet network in MetaMask
     */
    async function setupMonadNetwork() {
      const chainIdHex = MONAD_NETWORK.chainId; // "0x4EB7"
      try {
        // Try switching first
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: chainIdHex }],
        });
      } catch (switchError) {
        // If the chain is not added yet, add it
        if (switchError.code === 4902) {
          try {
            await window.ethereum.request({
              method: "wallet_addEthereumChain",
              params: [MONAD_NETWORK],
            });
          } catch (addError) {
            throw addError;
          }
        } else {
          throw switchError;
        }
      }
    }
  </script>
</body>
</html>
